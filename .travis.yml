if: tag =~ ^(\d+\.)?(\d+\.)?(\*|\d+)?(\*|\w+)?(\*|\d+)$
git:
  clone: false
language: python
matrix:
  include:
  - name: Python 3.7.3 on macOS 10.14
    os: osx
    osx_image: xcode10.2
    language: shell
    before_install:
    - python3 --version
    - python3 -m pip install -U pip wheel setuptools
    - python3 -m pip install -U poetry
    install:
    - git config --global user.name "NicklasTegner"
    - git config --global user.email "NicklasMCHD@live.dk"
    - echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" > ~/.ssh/known_hosts
    - git clone git@github.com:${TRAVIS_REPO_SLUG} $TRAVIS_REPO_SLUG
    - cd $TRAVIS_REPO_SLUG
    - git checkout -qf $TRAVIS_COMMIT
    - python3 -m poetry update
    - python3 -m poetry run python version_writer.py $TRAVIS_TAG
    - cd src
    - python3 -m poetry run python cython-compiler.py -c -e UtopiaForReddit.py
    - cd ../
    script:
    - python3 -m poetry run justupdate -d build specs/mac.spec
    - python3 -m poetry run justupdate -d commit $TRAVIS_TAG
    - python3 -m poetry run justupdate -d upload -s gh-archive
    - git add ju-repo/archive/*
    - git commit -m "Build version $TRAVIS_TAG on mac."
    - git pull origin master
    - openssl aes-256-cbc -k "$travis_key_password" -d -md sha256 -a -in utopia_key.enc -out travis_key
    - echo "Host github.com" > ~/.ssh/config
    - echo "  IdentityFile  $(pwd)/travis_key" >> ~/.ssh/config
    - chmod 400 travis_key
    - git push origin master
    - exit 0
  - name: Python 3.7.3 on Windows
    os: windows
    language: shell
    before_install:
    - choco install nsis --no-progress -r --x86
    - export PATH=$PATH:";C:\Program Files (x86)\NSIS"
    - choco install python --no-progress -r --x86 --version 3.7.3
    - python --version
    - python -m pip install --upgrade pip
    - pip3 install -U pip wheel setuptools
    - pip3 install -U poetry
    install:
    - git config --global user.name "NicklasTegner"
    - git config --global user.email "NicklasMCHD@live.dk"
    - echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" > ~/.ssh/known_hosts
    - git clone git@github.com:${TRAVIS_REPO_SLUG} $TRAVIS_REPO_SLUG
    - cd $TRAVIS_REPO_SLUG
    - git checkout -qf $TRAVIS_COMMIT
    - poetry update
    - poetry run python version_writer.py $TRAVIS_TAG
    - cd src
    - poetry run python cython-compiler.py -c -e UtopiaForReddit.py
    - cd ../
    script:
    - poetry run justupdate -d build specs/win-release.spec
    - poetry run justupdate -d commit $TRAVIS_TAG
    - poetry run justupdate -d upload -s gh-archive
    - rm src/__required_imports__.py
    - git add src/core/*
    - git add ju-repo/archive/*
    - git commit -m "Build version $TRAVIS_TAG on windows."
    - git checkout .
    - git pull origin master
    - openssl aes-256-cbc -k "$travis_key_password" -d -md sha256 -a -in utopia_key.enc -out travis_key
    - echo "Host github.com" > ~/.ssh/config
    - echo "  IdentityFile  $(pwd)/travis_key" >> ~/.ssh/config
    - chmod 400 travis_key
    - git push origin master
    env: PATH=/c/Python37:/c/Python37/Scripts:$PATH
env:
  global:
  - secure: drC/3F3at0QHChFabz+wn/ykFPHf2Yq6v2tcKoE3w2ncf2WYWpIrB/zhlA9Shu7c4TS6T5BLDPrzRi1iAbbsk5Ml2fwtlBN1YF7bmvY6/BTAJJLYu+ndDaQlmpjDj7C/8ooB/4RZTXTByM9ocsMG7bEiAf+JXBSAx4RbCq5uGhq83EWh0dz+JpPYhBr+N5rUr6g1MHT9u52w9dtGyfVNjKf8tar8mxzLPhd1usbN0yAdYmhyVxgUx9UbmOLPsXtLFULi8HMQI1zGbRWiI/k2NNEn8XVnPAoEhfEK6DcGPh8VU8g88vzoqTLaqGM5Y+I73TvBDTpNn+ZZMHtwndYlXvJxVxq8rpkzE/dt+gX+nOXE/aQ12+64H9QBtmuhgy9rVD+HhLlnK8DIBJZOuMaGHa0Z9bgEZAByX2Nnq8Zbm5fan8jtPedwMiGRbH8LN1iZSlpUCI45ovt6wifDRdDaa88YjnvqM3JrxdTwtgLZ0Aj3XxeYGXKFHf61ODawDMCE2Ih7utEcy/PiPDfyIy8Bx+YH3s52sys1GKTzGSRUTAg87b/ds52tU0iY7XcU8AMRfS4e64pywLgKohYC72BsqVfpkYbQ8dQe9LD5NuaJYmrDW+C0wMN0zBJUk/VXmSGUOKa00rOJu7RBU3W/tzKMr1gHyt7FZjiE7TmGrhBJ5no=
  - secure: I+jyy2QvP7GWd23seFjxlRMEJenC8j3Pe3cYG9BNebTJtR8ZxmIvKWCdAY0Iy9dGfWEPtFzI7T9rCrEYDK5Kyx0AOzUK37xiM15m6SQktSVKAKJwQ7mgS5lRotmv8ptjch0jaqgnlOIcVZhLLJhIOSfEUmKEllLOZk+ul5sRjpltBbWZ9KXMKSV/5o+q4Ai7p287OjUZI8d9JDHxQcesaEbImAAxv1pU/YQy8K9ELuqaC10TlWUBW2inyetAoYM/Rvs023lgaLNjn9i1sRXqWjwrbrg1iuEj0AxZQuMTvl4D2jfq+LnQCksfTcByXiSQulPGB6JMSvIpAWlX/mB+nMmE8u6y2Knyi8tE3WI1ix/ffJ3GBTJqZpd+2ld0wnN+sd69ag2AgmoFixuBL3n/zz79maP6KtlBnC0qfH/LAovZks/ReiM1nbIVw1AjIJyODubxgF7stKwLT6LomiD6amnK7e4zjPLA0+sSTpsuV8bH7VmCe5Ow2b2HchImNe9w449uRqJrMz/efPMMMf0PXJmQ0zEApbC+ejegXHI18YCyrMuTZvjubqgNgGOaOrYkMv75JI1p3ewDzaQUqSHz3dpNqh5HnkO7+Njcl/ttrKTvthILGFDcLBcyYoRoY8xuPKEv1HwRSKsdxdlx6shPSl11IbsHh6WlWkoQmB0mKB0=
